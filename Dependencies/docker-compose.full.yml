version: '3.9'
name: afdb-cc-local

services:
  # SQL Server
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: afdb_sqlserver
    restart: unless-stopped
    environment:
      SA_PASSWORD: "aDb#Cc@Pwd!dev"
      ACCEPT_EULA: "Y"
    ports:
      - "5001:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
    networks:
      - afdb_net
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P 'aDb#Cc@Pwd!dev' -Q 'SELECT 1' || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # API Backend
  api:
    build:
      context: ..
      dockerfile: src/Afdb.ClientConnection.Api/Dockerfile
    container_name: afdb_api
    restart: unless-stopped
    ports:
      - "5000:8080"
      - "5001:8081"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080

      # Database
      - ConnectionStrings__DbConnectionString=Server=sqlserver,1433;Database=ClientConnection;User Id=sa;Password=aDb#Cc@Pwd!dev;TrustServerCertificate=True;

      # Azure AD (utilise tes valeurs existantes)
      - AzureAd__Instance=https://login.microsoftonline.com/
      - AzureAd__TenantId=515af266-ba4c-4452-a190-d3a7520a6957
      - AzureAd__ClientId=586ffe0a-59c4-4e52-af81-be102e2e6e07
      - AzureAd__Audience=api://586ffe0a-59c4-4e52-af81-be102e2e6e07
      - AzureAd__Domain=devmouslimattoutlook.onmicrosoft.com

      # Key Vault (désactivé en local)
      - KeyVault__VaultUri=

      # CORS
      - Cors__AllowedOrigins__0=http://localhost:4200
      - Cors__AllowedOrigins__1=http://localhost:3000
      - Cors__AllowedOrigins__2=http://localhost:5173

      # Mocks activés pour développement local
      - Graph__UseMock=true
      - Sap__UseMock=true
      - SharePoint__UseSharePointStorage=false

    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - afdb_net
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 60s

volumes:
  sqlserver_data:
    name: afdb_sqlserver_data

networks:
  afdb_net:
    driver: bridge
    name: afdb_network
